import asyncio
import html as html_escape
import logging
import os
import re
import time
from datetime import datetime

import requests
from aiogram.types import FSInputFile


# –£–±–∏—Ä–∞–µ–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç
# –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: from bot.utils import send_web_request

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è rate limiting
LAST_REQUEST_TIME = 0
MIN_REQUEST_INTERVAL = 0.5  # —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

API_BASE_URL = "https://infosearch54321.xyz"

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ñ–∞–π–ª .env)
API_TOKEN = os.getenv("API_TOKEN")

# –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
PATTERNS = {
    "–§–ò–û": r"^[–ê-–Ø–ÅA-Z][–∞-—è—ëa-z]+\s[–ê-–Ø–Åa-z][–∞-—è—ëa-z]+(\s[–ê-–Ø–ÅA-Z][–∞-—è—ëa-z]+)?(\s\d{2}\.\d{2}(\.\d{4})?)?$",
    "–ê–≤—Ç–æ (–≥–æ—Å. –Ω–æ–º–µ—Ä)": r"^[–ê-–Ø–ÅA-Z]\d{3}[–ê-–Ø–Åa-zA-Z]{2}\d{2,3}$",
    "–ê–≤—Ç–æ (VIN)": r"^[A-HJ-NPR-Z0-9]{17}$",
    "–¢–µ–ª–µ—Ñ–æ–Ω": r"^(7|3)\d{10}$",
    "–ü–æ—á—Ç–∞": r"^[a-zA-Z0-9_.+\-]+@[a-zA-Z0-9\-]+\.[a-zA-Z0-9.\-]+$",
    "–õ–æ–≥–∏–Ω": r"^\w{3,20}$",
    "–ü–∞—Å–ø–æ—Ä—Ç": r"^\d{4}\s?\d{6}$",
    "–ò–ù–ù": r"^\d{10,12}$",
    "–°–ù–ò–õ–°": r"^\d{11}$",
    "–û–ì–†–ù": r"^\d{13}$"
}

# –ü–µ—Ä–µ–≤–æ–¥ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ translate_database_entry, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
DATABASE_TRANSLATIONS = {}


async def send_web_request(query: str, session_pool_instance=None):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Sauron

    :param query: –°—Ç—Ä–æ–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    :param session_pool_instance: –≠–∫–∑–µ–º–ø–ª—è—Ä –ø—É–ª–∞ —Å–µ—Å—Å–∏–π –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    :return: (success, data_or_error)
    """
    logging.info(f"Web request for query: {query}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—É–ª —Å–µ—Å—Å–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if session_pool_instance is None:
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—É–ª —Å–µ—Å—Å–∏–π
        from bot.session_manager import session_pool
        session_pool_instance = session_pool

    if session_pool_instance is None:
        logging.error("–û—à–∏–±–∫–∞: –ø—É–ª —Å–µ—Å—Å–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞")
        return False, "–û—à–∏–±–∫–∞: —Å–∏—Å—Ç–µ–º–∞ –≤–µ–±-–ø–æ–∏—Å–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–∞–ø—Ä–æ—Å
    normalized_query = normalize_query(query)

    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ –ø—É–ª —Å–µ—Å—Å–∏–π
    success, result = await session_pool_instance.perform_search(normalized_query)

    # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if success:
        logging.info(
            f"Web request succeeded for query: {query}, found {len(result) if isinstance(result, list) else 0} records")
    else:
        logging.error(f"Web request failed for query: {query}, error: {result}")

    return success, result


async def send_api_request(query: str):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∞–π—Ç–∞ –≤–º–µ—Å—Ç–æ API.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (success, data_or_error):
      success = True  => data_or_error = —Ä–µ–∑—É–ª—å—Ç–∞—Ç (list –∏–ª–∏ dict)
      success = False => data_or_error = —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (str)
    """
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    from bot.main import session_pool

    if not query:
        return False, "–ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å"

    logging.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: {query}")
    start_time = time.time()

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—É–ª —Å–µ—Å—Å–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
        if session_pool is None:
            return False, "–û—à–∏–±–∫–∞: –ø—É–ª —Å–µ—Å—Å–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"

        # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        success, result = await send_web_request(query, session_pool)

        end_time = time.time()
        execution_time = round(end_time - start_time, 2)

        if success:
            logging.info(
                f"–ó–∞–ø—Ä–æ—Å '{query}' –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞ {execution_time} —Å–µ–∫. –ü–æ–ª—É—á–µ–Ω–æ {len(result) if isinstance(result, list) else 0} –∑–∞–ø–∏—Å–µ–π")
            return True, result
        else:
            error_message = result if isinstance(result, str) else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
            logging.error(f"–û—à–∏–±–∫–∞ –≤–µ–±-–ø–æ–∏—Å–∫–∞: {error_message}")
            return False, error_message

    except Exception as e:
        end_time = time.time()
        execution_time = round(end_time - start_time, 2)

        logging.error(f"–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤–µ–±-–∑–∞–ø—Ä–æ—Å–∞ '{query}' ({execution_time} —Å–µ–∫): {e}")
        return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: {str(e)}"


async def send_extended_api_request(query: str):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
    –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ –º–µ—Ç–æ–¥, —á—Ç–æ –∏ –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (success, data_or_error) –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ send_api_request.
    """
    # –í –≤–µ–±-–≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –º–µ—Ç–æ–¥, —á—Ç–æ –∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞,
    # —Ç–∞–∫ –∫–∞–∫ –Ω–∞ —Å–∞–π—Ç–µ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –æ–±—ã—á–Ω—ã–π –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
    return await send_api_request(query)


def validate_query(query: str):
    """
    –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –¥–ª—è –§–ò–û+–¥–∞—Ç–∞
    """
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤–≤–æ–¥ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    query = format_fio_and_date(query)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–¥–Ω–æ–º—É –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤
    for pattern_name, pattern in PATTERNS.items():
        if re.match(pattern, query):
            return True, query  # query —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω

    # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –§–ò–û + –¥–∞—Ç–∞
    fio_date_pattern = r"^[–ê-–Ø–ÅA-Z][–∞-—è—ëa-z]+(\s[–ê-–Ø–ÅA-Z][–∞-—è—ëa-z]+){1,2}\s\d{2}\.\d{2}\.\d{4}$"
    if re.match(fio_date_pattern, query):
        return True, query

    # –û—Å–æ–±–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –§–ò–û+–¥–∞—Ç–∞ —Å –æ—à–∏–±–∫–∞–º–∏
    words = query.strip().split()
    if len(words) >= 3:  # –ú–∏–Ω–∏–º—É–º: –§–∞–º–∏–ª–∏—è –ò–º—è –î–î.–ú–ú.–ì–ì–ì–ì
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞—Ç—ã –≤ –ª—é–±–æ–π —á–∞—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞
        date_pattern = r"(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})"

        for word in words:
            match = re.match(date_pattern, word)
            if match:
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∞—Å—Ç–∏ –§–ò–û –∏ –¥–∞—Ç—É
                fio_parts = [w.capitalize() for w in words if not re.match(date_pattern, w)]

                day, month, year = match.groups()
                day = day.zfill(2)
                month = month.zfill(2)

                if len(year) == 2:
                    year_prefix = "20" if int(year) < 30 else "19"
                    year = year_prefix + year

                date = f"{day}.{month}.{year}"

                formatted_query = " ".join(fio_parts) + " " + date
                return True, formatted_query

    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    help_text = (
        "‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã:\n\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ –§–ò–û: `–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω 01.01.2000`\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ (–≥–æ—Å. –Ω–æ–º–µ—Ä): `–ê001–ê–ê77`\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ VIN: `XTA212130T1186583`\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: `79221110500`\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ –ø–æ—á—Ç–µ: `ivanov@mail.ru`\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ –ø–∞—Å–ø–æ—Ä—Ç—É: `4616 233456`\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ –ò–ù–ù: `7707083893`\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ –°–ù–ò–õ–°: `00461487830`\n"
        "üìå –ü–æ–∏—Å–∫ –ø–æ –û–ì–†–ù: `1027739099772`\n"
    )
    return False, help_text


# –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ format_api_response –≤ —Ñ–∞–π–ª–µ utils.py

def format_api_response(api_response, limit_length=True, max_length=3800, use_html=True):
    """
    –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏ –∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —É–¥–æ–±–Ω–æ–º –¥–ª—è —á—Ç–µ–Ω–∏—è –≤–∏–¥–µ, —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤,
    —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –∑–∞–ø–∏—Å–µ–π –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–µ–π.

    :param api_response: –û—Ç–≤–µ—Ç API –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    :param limit_length: –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –ª–∏ –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è
    :param max_length: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    :param use_html: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ HTML-—Ç–µ–≥–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    :return: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    """
    if not api_response:
        return "‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."

    # –ù–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π -> —ç–º–æ–¥–∑–∏
    categories = {
        "–ó–ê–ü–ò–°–ê–ù –í –ë–ê–ó–ê–•": "üë§",
        "–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø": "üéÇ",
        "–¢–ï–õ–ï–§–û–ù": "üìû",
        "–ü–û–ß–¢–ê": "üìß",
        "–ò–ù–ù": "üí≥",
        "–ü–ê–°–ü–û–†–¢": "üÜî",
        "–°–ù–ò–õ–°": "üìë"
    }

    # –ü–æ—Ä—è–¥–æ–∫ –≤—ã–≤–æ–¥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    category_order = [
        "–ó–ê–ü–ò–°–ê–ù –í –ë–ê–ó–ê–•",
        "–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø",
        "–¢–ï–õ–ï–§–û–ù",
        "–ü–û–ß–¢–ê",
        "–ò–ù–ù",
        "–ü–ê–°–ü–û–†–¢",
        "–°–ù–ò–õ–°"
    ]

    data_store = {cat: [] for cat in categories}
    unique_databases = set()
    total_records = 0

    # –î–ª—è –¥–∞–Ω–Ω—ã—Ö FSSP
    fssp_data = []
    total_debt = 0  # –û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏

    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∑–∞–ø–∏—Å—è–º, —Å–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    for record in api_response:
        if not isinstance(record, dict):
            continue
        total_records += 1

        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —É—á—ë—Ç –±–∞–∑
        db_name = record.get("database", "").lower()
        if db_name:
            unique_databases.add(db_name)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –±–∞–∑–∞ FSSP –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—è—Ö
            is_fssp = False
            if 'fssp' in db_name or '–ø—Ä–∏—Å—Ç–∞–≤' in db_name or '–∏—Å–ø–æ–ª–Ω–∏—Ç' in db_name:
                is_fssp = True
            else:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–ª—è–º, –¥–∞–∂–µ –µ—Å–ª–∏ –±–∞–∑–∞ –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç FSSP –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
                for key in record.keys():
                    upper_key = key.upper() if isinstance(key, str) else ""
                    if "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨" in upper_key or "–î–û–õ–ì" in upper_key or "–ò–ü" in upper_key or "–ü–†–ò–°–¢–ê–í" in upper_key:
                        is_fssp = True
                        break

            if is_fssp:
                fssp_item = {}

                # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏
                for key, value in record.items():
                    if isinstance(key, str):
                        fssp_item[key.upper()] = value

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –ø–æ–ª–µ–π
                if "–î–û–õ–ì" in fssp_item and "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨" not in fssp_item:
                    fssp_item["–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨"] = fssp_item["–î–û–õ–ì"]
                if "–û–°–ü" in fssp_item and "–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô" not in fssp_item:
                    fssp_item["–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô"] = fssp_item["–û–°–ü"]

                # –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É–º–º–∞ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –æ–±—â–µ–π —Å—É–º–º—ã
                if "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨" in fssp_item:
                    try:
                        debt_amount = fssp_item["–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨"]
                        if isinstance(debt_amount, str):
                            # –£–¥–∞–ª—è–µ–º –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Ç–æ—á–∫–∏ –∏ –∑–∞–ø—è—Ç–æ–π
                            debt_str = ''.join(c for c in debt_amount if c.isdigit() or c in '.,')
                            debt_str = debt_str.replace(',', '.')
                            debt_value = float(debt_str)
                            total_debt += debt_value
                            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤—ã–≤–æ–¥–∞
                            fssp_item["–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û"] = debt_value
                    except (ValueError, TypeError):
                        pass  # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —á–∏—Å–ª–æ, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

                # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∑–∞–ø–∏—Å—å –Ω–µ –ø—É—Å—Ç–∞—è
                if fssp_item:
                    fssp_data.append(fssp_item)

        # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        for key, value in record.items():
            if not isinstance(key, str):
                continue

            key_upper = key.upper()

            # –§–ò–û
            if key_upper == "–§–ò–û" and value and value not in data_store["–ó–ê–ü–ò–°–ê–ù –í –ë–ê–ó–ê–•"]:
                data_store["–ó–ê–ü–ò–°–ê–ù –í –ë–ê–ó–ê–•"].append(value)

            # –î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø
            elif key_upper == "–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø" and value and value not in data_store["–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø"]:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É (–µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –î–î.–ú–ú.–ì–ì–ì–ì)
                data_store["–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø"].append(value)

            # –¢–ï–õ–ï–§–û–ù
            elif key_upper == "–¢–ï–õ–ï–§–û–ù":
                if value:
                    if isinstance(value, list):
                        for p in value:
                            if p and p not in data_store["–¢–ï–õ–ï–§–û–ù"]:
                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                                phone = format_phone_number(p)
                                if phone and phone not in data_store["–¢–ï–õ–ï–§–û–ù"]:
                                    data_store["–¢–ï–õ–ï–§–û–ù"].append(phone)
                    else:
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                        phone = format_phone_number(value)
                        if phone and phone not in data_store["–¢–ï–õ–ï–§–û–ù"]:
                            data_store["–¢–ï–õ–ï–§–û–ù"].append(phone)

            # –ü–û–ß–¢–ê
            elif key_upper == "–ü–û–ß–¢–ê":
                if value:
                    if isinstance(value, list):
                        for em in value:
                            if em and em not in data_store["–ü–û–ß–¢–ê"] and isinstance(em, str) and "@" in em:
                                data_store["–ü–û–ß–¢–ê"].append(em)
                    else:
                        if value not in data_store["–ü–û–ß–¢–ê"] and isinstance(value, str) and "@" in value:
                            data_store["–ü–û–ß–¢–ê"].append(value)

            # –ò–ù–ù
            elif key_upper == "–ò–ù–ù" and value and value not in data_store["–ò–ù–ù"]:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ò–ù–ù (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)
                if isinstance(value, str) and value.isdigit() and len(value) in (10, 12):
                    data_store["–ò–ù–ù"].append(value)

            # –ü–ê–°–ü–û–†–¢
            elif key_upper == "–ü–ê–°–ü–û–†–¢":
                if value:
                    if isinstance(value, list):
                        for pas in value:
                            if pas and pas not in data_store["–ü–ê–°–ü–û–†–¢"]:
                                data_store["–ü–ê–°–ü–û–†–¢"].append(pas)
                    else:
                        if value not in data_store["–ü–ê–°–ü–û–†–¢"]:
                            data_store["–ü–ê–°–ü–û–†–¢"].append(value)

            # –°–ù–ò–õ–°
            elif key_upper == "–°–ù–ò–õ–°" and value and value not in data_store["–°–ù–ò–õ–°"]:
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –°–ù–ò–õ–°, –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Ü–∏—Ñ—Ä
                if isinstance(value, str):
                    # –£–¥–∞–ª—è–µ–º –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
                    snils_digits = ''.join(c for c in value if c.isdigit())
                    if len(snils_digits) == 11:
                        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º: XXX-XXX-XXX XX
                        formatted_snils = f"{snils_digits[:3]}-{snils_digits[3:6]}-{snils_digits[6:9]} {snils_digits[9:]}"
                        data_store["–°–ù–ò–õ–°"].append(formatted_snils)
                    else:
                        data_store["–°–ù–ò–õ–°"].append(value)
                else:
                    data_store["–°–ù–ò–õ–°"].append(value)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞
    lines = []

    # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ FSSP, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π "—Å–∏–≥–Ω–∞–ª—å–Ω—ã–π" –±–ª–æ–∫
    if fssp_data:
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ —Å—É–º–º–µ (–æ—Ç –±–æ–ª—å—à–µ–π –∫ –º–µ–Ω—å—à–µ–π)
        fssp_data_sorted = sorted(
            fssp_data,
            key=lambda x: x.get("–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û", 0) if "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û" in x else 0,
            reverse=True
        )

        # –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ —Å –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—è–º–∏
        if use_html:
            lines.append("<b>üö® –í–ù–ò–ú–ê–ù–ò–ï! –ù–ê–ô–î–ï–ù–´ –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ò–ó–í–û–î–°–¢–í–ê üö®</b>")
            lines.append(f"<b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {len(fssp_data)}</b>")
            if total_debt > 0:
                lines.append(f"<b>–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏: <code>{total_debt:.2f}‚ÇΩ</code></b>")
        else:
            lines.append("üö® –í–ù–ò–ú–ê–ù–ò–ï! –ù–ê–ô–î–ï–ù–´ –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ò–ó–í–û–î–°–¢–í–ê üö®")
            lines.append(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {len(fssp_data)}")
            if total_debt > 0:
                lines.append(f"–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏: {total_debt:.2f}‚ÇΩ")
        lines.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è

    if use_html:
        lines.append("<b>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</b>\n")
    else:
        lines.append("–ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n")

    # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ FSSP, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—è—Ö
    if fssp_data:
        if use_html:
            lines.append("‚öñÔ∏è <b>–î–ê–ù–ù–´–ï –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ü–†–û–ò–ó–í–û–î–°–¢–í:</b>")
        else:
            lines.append("‚öñÔ∏è –î–ê–ù–ù–´–ï –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ü–†–û–ò–ó–í–û–î–°–¢–í:")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ (–¥–æ 10 –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–µ–π)
        max_fssp_to_show = min(10, len(fssp_data_sorted))
        for i, entry in enumerate(fssp_data_sorted[:max_fssp_to_show], 1):
            # –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–æ—Ä—è–¥–∫–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∏ —Å—É–º–º—ã
            if use_html:
                base_info = f"<b>–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å {i}</b>"
                if "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û" in entry:
                    base_info += f" - <b><code>{entry['–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û']:.2f}‚ÇΩ</code></b>"
                elif "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨" in entry:
                    base_info += f" - <b><code>{entry['–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨']}‚ÇΩ</code></b>"
                elif "–î–û–õ–ì" in entry:
                    base_info += f" - <b><code>{entry['–î–û–õ–ì']}‚ÇΩ</code></b>"
            else:
                base_info = f"–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å {i}"
                if "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û" in entry:
                    base_info += f" - {entry['–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û']:.2f}‚ÇΩ"
                elif "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨" in entry:
                    base_info += f" - {entry['–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨']}‚ÇΩ"
                elif "–î–û–õ–ì" in entry:
                    base_info += f" - {entry['–î–û–õ–ì']}‚ÇΩ"

            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É
            lines.append(f"  ‚Ä¢ {base_info}")

            # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            details = []

            # –î–∞—Ç–∞ –ò–ü
            if "–î–ê–¢–ê –ò–ü" in entry:
                if use_html:
                    details.append(f"–î–∞—Ç–∞: <code>{entry['–î–ê–¢–ê –ò–ü']}</code>")
                else:
                    details.append(f"–î–∞—Ç–∞: {entry['–î–ê–¢–ê –ò–ü']}")

            # –ù–æ–º–µ—Ä –ò–ü
            if "–ù–û–ú–ï–† –ò–ü" in entry:
                if use_html:
                    details.append(f"‚Ññ–ò–ü: <code>{entry['–ù–û–ú–ï–† –ò–ü']}</code>")
                else:
                    details.append(f"‚Ññ–ò–ü: {entry['–ù–û–ú–ï–† –ò–ü']}")

            # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π/–û–°–ü
            if "–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô" in entry:
                comment = entry["–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô"]
                if len(comment) > 30:  # –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, —Å–æ–∫—Ä–∞—â–∞–µ–º
                    comment = comment[:27] + "..."
                if use_html:
                    details.append(f"–û–°–ü: <code>{comment}</code>")
                else:
                    details.append(f"–û–°–ü: {comment}")

            # –ê–¥—Ä–µ—Å
            if "–ê–î–†–ï–°" in entry:
                address = entry["–ê–î–†–ï–°"]
                if len(address) > 40:  # –ï—Å–ª–∏ –∞–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, —Å–æ–∫—Ä–∞—â–∞–µ–º
                    address = address[:37] + "..."
                if use_html:
                    details.append(f"–ê–¥—Ä–µ—Å: <code>{address}</code>")
                else:
                    details.append(f"–ê–¥—Ä–µ—Å: {address}")

            # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ç–∞–ª–∏, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ —Å –æ—Ç—Å—Ç—É–ø–æ–º
            if details:
                lines.append(f"    {' | '.join(details)}")

        # –ï—Å–ª–∏ –µ—Å—Ç—å –µ—â–µ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
        if len(fssp_data) > max_fssp_to_show:
            lines.append(f"  ‚Ä¢ ... –∏ –µ—â–µ {len(fssp_data) - max_fssp_to_show} –∑–∞–ø–∏—Å–µ–π")

        lines.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    max_items_per_category = 15 if limit_length else float('inf')

    # –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    for cat_name in category_order:
        items = data_store[cat_name]
        if not items:
            continue

        emoji = categories[cat_name]
        if use_html:
            lines.append(f"{emoji} <b>{cat_name}:</b>")
        else:
            lines.append(f"{emoji} {cat_name}:")

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        sorted_items = sorted_items_by_category(cat_name, items)

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
        items_to_show = sorted_items[:max_items_per_category] if limit_length else sorted_items

        for val in items_to_show:
            # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ <code> –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Telegram (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ use_html=True)
            if use_html:
                lines.append(f"  ‚Ä¢ <code>{val}</code>")
            else:
                lines.append(f"  ‚Ä¢ {val}")

        # –ï—Å–ª–∏ –ø–æ–∫–∞–∑–∞–Ω—ã –Ω–µ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
        if limit_length and len(sorted_items) > max_items_per_category:
            lines.append(f"  ‚Ä¢ ... –∏ –µ—â–µ {len(sorted_items) - max_items_per_category} –∑–∞–ø–∏—Å–µ–π")

        lines.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏

    # –í –∫–æ–Ω—Ü–µ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–∑–∞—Ö –∏ –∑–∞–ø–∏—Å—è—Ö
    bases_count = len(unique_databases)
    lines.append(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–∑: {bases_count}")
    lines.append(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {total_records}")

    # –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏, –ø–æ–≤—Ç–æ—Ä—è–µ–º —ç—Ç–æ –≤ –∫–æ–Ω—Ü–µ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è
    if fssp_data:
        if use_html:
            lines.append(f"<b>–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤: {len(fssp_data)}</b>")
        else:
            lines.append(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤: {len(fssp_data)}")

    lines.append("\n–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ñ–∞–π–ª–µ –Ω–∏–∂–µ üìÇ")

    # –°–∫–ª–µ–∏–≤–∞–µ–º –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
    full_message = "\n".join(lines)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É—Ä–µ–∑–∞–µ–º
    if limit_length and len(full_message) > max_length:
        # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if use_html:
            short_message = "<b>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π –≤–∏–¥):</b>\n\n"
        else:
            short_message = "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π –≤–∏–¥):\n\n"

        # –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–æ –≤ –∫—Ä–∞—Ç–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        if fssp_data:
            if use_html:
                short_message += "<b>üö® –í–ù–ò–ú–ê–ù–ò–ï! –ù–ê–ô–î–ï–ù–´ –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ò–ó–í–û–î–°–¢–í–ê üö®</b>\n"
                short_message += f"<b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(fssp_data)}</b>\n"
                if total_debt > 0:
                    short_message += f"<b>–û–±—â–∞—è —Å—É–º–º–∞: <code>{total_debt:.2f}‚ÇΩ</code></b>\n\n"
            else:
                short_message += "üö® –í–ù–ò–ú–ê–ù–ò–ï! –ù–ê–ô–î–ï–ù–´ –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ò–ó–í–û–î–°–¢–í–ê üö®\n"
                short_message += f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(fssp_data)}\n"
                if total_debt > 0:
                    short_message += f"–û–±—â–∞—è —Å—É–º–º–∞: {total_debt:.2f}‚ÇΩ\n\n"

            # –î–æ–±–∞–≤–ª—è–µ–º 1-3 –∑–∞–ø–∏—Å–∏ —Å –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—è–º–∏ –¥–∞–∂–µ –≤ –∫—Ä–∞—Ç–∫–æ–º –≤–∏–¥–µ
            if use_html:
                short_message += "‚öñÔ∏è <b>–î–ê–ù–ù–´–ï –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ü–†–û–ò–ó–í–û–î–°–¢–í:</b>\n"
            else:
                short_message += "‚öñÔ∏è –î–ê–ù–ù–´–ï –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ü–†–û–ò–ó–í–û–î–°–¢–í:\n"

            for i, entry in enumerate(fssp_data_sorted[:3], 1):
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏
                if use_html:
                    debt_line = f"<b>–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å {i}</b>"
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º—É –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    if "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û" in entry:
                        debt_line += f" - <b><code>{entry['–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û']:.2f}‚ÇΩ</code></b>"
                    elif "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨" in entry:
                        debt_line += f" - <b><code>{entry['–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨']}‚ÇΩ</code></b>"
                    elif "–î–û–õ–ì" in entry:
                        debt_line += f" - <b><code>{entry['–î–û–õ–ì']}‚ÇΩ</code></b>"
                else:
                    debt_line = f"–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å {i}"
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º—É –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    if "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û" in entry:
                        debt_line += f" - {entry['–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨_–ß–ò–°–õ–û']:.2f}‚ÇΩ"
                    elif "–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨" in entry:
                        debt_line += f" - {entry['–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨']}‚ÇΩ"
                    elif "–î–û–õ–ì" in entry:
                        debt_line += f" - {entry['–î–û–õ–ì']}‚ÇΩ"

                short_message += f"  ‚Ä¢ {debt_line}\n"

            if len(fssp_data) > 3:
                short_message += f"  ‚Ä¢ ... –∏ –µ—â–µ {len(fssp_data) - 3} –∑–∞–ø–∏—Å–µ–π\n"

            short_message += "\n"

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ø–∏—Ä—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫—Ä–∞—Ç–∫–∏–π –≤–∏–¥ (–ø–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)
        for cat_name in ["–ó–ê–ü–ò–°–ê–ù –í –ë–ê–ó–ê–•", "–¢–ï–õ–ï–§–û–ù", "–ü–û–ß–¢–ê", "–ò–ù–ù", "–ü–ê–°–ü–û–†–¢"]:
            items = data_store[cat_name]
            if items:
                emoji = categories[cat_name]

                # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫—Ä–∞—Ç–∫–æ–≥–æ –≤–∏–¥–∞
                max_short = 5 if cat_name == "–¢–ï–õ–ï–§–û–ù" else 3
                sorted_items = sorted_items_by_category(cat_name, items)
                items_to_show = sorted_items[:max_short]

                if use_html:
                    short_message += f"{emoji} <b>{cat_name}:</b>\n"
                    for val in items_to_show:
                        short_message += f"  ‚Ä¢ <code>{val}</code>\n"
                else:
                    short_message += f"{emoji} {cat_name}:\n"
                    for val in items_to_show:
                        short_message += f"  ‚Ä¢ {val}\n"

                if len(sorted_items) > max_short:
                    short_message += f"  ‚Ä¢ ... –∏ –µ—â–µ {len(sorted_items) - max_short} –∑–∞–ø–∏—Å–µ–π\n"

                short_message += "\n"

        short_message += (
            f"–í—Å–µ–≥–æ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö: {bases_count}\n"
            f"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total_records}\n\n"
            "‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram.\n"
            "–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ñ–∞–π–ª–µ –Ω–∏–∂–µ üìÇ"
        )
        return short_message

    return full_message


def format_phone_number(phone_str):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –≤–∏–¥—É –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.
    –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –Ω–æ–º–µ—Ä–∞, —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –º–æ–±–∏–ª—å–Ω—ã–µ –∏ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–µ –Ω–æ–º–µ—Ä–∞.

    :param phone_str: –°—Ç—Ä–æ–∫–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º
    :return: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ None
    """
    if not phone_str:
        return None

    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ –ø–ª—é—Å–∞ –≤ –Ω–∞—á–∞–ª–µ
    original = str(phone_str).strip()
    has_plus = original.startswith('+')
    digits_only = ''.join(c for c in original if c.isdigit())

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É (–æ—Ç—Å–µ–∏–≤–∞–µ–º —è–≤–Ω–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ)
    if len(digits_only) < 7:  # –ú–∏–Ω–∏–º—É–º 7 —Ü–∏—Ñ—Ä –¥–ª—è –≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞
        return None

    # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –º–æ–±–∏–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    # –ú–æ–±–∏–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –†–æ—Å—Å–∏–∏: +7XXX-XXX-XX-XX (11 —Ü–∏—Ñ—Ä —Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã)
    if len(digits_only) == 10 and digits_only[0] in ['9']:
        # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ 9 –∏ –¥–ª–∏–Ω–∞ 10 - —ç—Ç–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –º–æ–±–∏–ª—å–Ω—ã–π –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
        return f"+7{digits_only}"
    elif len(digits_only) == 11 and digits_only[0] in ['7', '8']:
        # –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ 7 –∏–ª–∏ 8 –∏ –¥–ª–∏–Ω–∞ 11 - —ç—Ç–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä —Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã
        return f"+7{digits_only[1:]}"

    # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –†–æ—Å—Å–∏–∏
    # –°—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –≤ –†–æ—Å—Å–∏–∏ –æ–±—ã—á–Ω–æ –∏–º–µ—é—Ç –∫–æ–¥ –≥–æ—Ä–æ–¥–∞ (3-5 —Ü–∏—Ñ—Ä) + –Ω–æ–º–µ—Ä (5-7 —Ü–∏—Ñ—Ä)
    if 7 <= len(digits_only) <= 10:
        # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
        # –ì–æ—Ä–æ–¥—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞ —á–∞—Å—Ç–æ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 2, 3, 4, 5
        if digits_only[0] in ['2', '3', '4', '5']:
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥ –†–æ—Å—Å–∏–∏
            return f"+7{digits_only}"

    # 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    # –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–¥—ã —Å—Ç—Ä–∞–Ω
    country_codes = {
        '1': '–°–®–ê/–ö–∞–Ω–∞–¥–∞',  # +1: 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '44': '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',  # +44: 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '49': '–ì–µ—Ä–º–∞–Ω–∏—è',  # +49: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞
        '33': '–§—Ä–∞–Ω—Ü–∏—è',  # +33: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '86': '–ö–∏—Ç–∞–π',  # +86: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞
        '81': '–Ø–ø–æ–Ω–∏—è',  # +81: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞
        '39': '–ò—Ç–∞–ª–∏—è',  # +39: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞
        '34': '–ò—Å–ø–∞–Ω–∏—è',  # +34: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '380': '–£–∫—Ä–∞–∏–Ω–∞',  # +380: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '375': '–ë–µ–ª–∞—Ä—É—Å—å',  # +375: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '998': '–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω',  # +998: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '996': '–ö–∏—Ä–≥–∏–∑–∏—è',  # +996: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '374': '–ê—Ä–º–µ–Ω–∏—è',  # +374: 8 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '995': '–ì—Ä—É–∑–∏—è',  # +995: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '994': '–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω',  # +994: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '992': '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω',  # +992: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
        '7': '–†–æ—Å—Å–∏—è/–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω'  # +7: 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
    }

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
    if has_plus and len(digits_only) >= 8:
        # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å + –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–π - –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
        return f"+{digits_only}"

    # –î–ª—è –Ω–æ–º–µ—Ä–æ–≤ –±–µ–∑ + –≤ –Ω–∞—á–∞–ª–µ, –Ω–æ –¥–ª–∏–Ω–æ–π 11-15 —Ü–∏—Ñ—Ä,
    # —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä —Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã
    if len(digits_only) >= 11 and len(digits_only) <= 15:
        # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã
        for code in sorted(country_codes.keys(), key=len, reverse=True):
            if digits_only.startswith(code):
                return f"+{digits_only}"

        # –ï—Å–ª–∏ –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –Ω–æ –¥–ª–∏–Ω–∞ –ø–æ–¥—Ö–æ–¥—è—â–∞—è - —Å—á–∏—Ç–∞–µ–º –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º
        return f"+{digits_only}"

    # 4. –ï—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –¥–ª–∏–Ω–∞ –ø—Ä–∏–µ–º–ª–µ–º–∞—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (7-15 —Ü–∏—Ñ—Ä)
    if 7 <= len(digits_only) <= 15:
        # –î–ª—è –Ω–æ–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 8, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ +7 (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
        if digits_only[0] == '8' and len(digits_only) == 11:
            return f"+7{digits_only[1:]}"
        # –ò–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º + –≤ –Ω–∞—á–∞–ª–æ
        return f"+{digits_only}"

    # –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–æ—à–ª–æ –Ω–∏ –ø–æ–¥ –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞–∫ –µ—Å—Ç—å
    return original


def sorted_items_by_category(category, items):
    """
    –°–æ—Ä—Ç–∏—Ä—É–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

    :param category: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    :param items: –°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    :return: –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    """
    if category == "–ó–ê–ü–ò–°–ê–ù –í –ë–ê–ó–ê–•":
        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –§–ò–û –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        return sorted(items)
    elif category == "–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø":
        # –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–∞—Ç (–µ—Å–ª–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì)
        try:
            # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –¥–∞—Ç—ã
            from datetime import datetime

            def parse_date(date_str):
                try:
                    if isinstance(date_str, str) and '.' in date_str:
                        parts = date_str.split('.')
                        if len(parts) == 3:
                            return datetime(int(parts[2]), int(parts[1]), int(parts[0]))
                    return datetime(1900, 1, 1)  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                except:
                    return datetime(1900, 1, 1)  # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞

            return sorted(items, key=parse_date)
        except:
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ—Å—Ç–æ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            return sorted(items)
    elif category == "–¢–ï–õ–ï–§–û–ù":
        # –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ - —Å–Ω–∞—á–∞–ª–∞ –º–æ–±–∏–ª—å–Ω—ã–µ (+7), –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
        mobile = []
        other = []

        for phone in items:
            if phone and isinstance(phone, str) and phone.startswith('+7'):
                mobile.append(phone)
            else:
                other.append(phone)

        return sorted(mobile) + sorted(other)
    else:
        # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π - –ø—Ä–æ—Å—Ç–æ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        return sorted(items)

def translate_database_entry(database_entry: str) -> str:
    """
    –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏—è database –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç, –∏—Å–ø–æ–ª—å–∑—É—è —Å–ª–æ–≤–∞—Ä—å DATABASE_TRANSLATIONS.
    """
    words = database_entry.split()
    translated_words = [DATABASE_TRANSLATIONS.get(word.lower(), word) for word in words]
    return " ".join(translated_words)


async def save_response_as_html(user_id: int, query: str, api_response) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML-—Ñ–∞–π–ª –≤ —Ç–µ–º–Ω–æ–º —Ç–∞–±–ª–∏—á–Ω–æ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ,
    –≤—ã–≤–æ–¥—è –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ api_response.

    :param user_id: –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ /static/responses/<user_id>
    :param query: –Ω–∞–ø—Ä–∏–º–µ—Ä, '–ë–∞–ª–∞–±–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π –û–ª–µ–≥–æ–≤–∏—á'
    :param api_response: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π. –ö–∞–∂–¥—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á "database"
                        + –ª–∏–±–æ "fields" (—Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π), –ª–∏–±–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –∫–ª—é—á–∏.
    :return: –ü—É—Ç—å –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É HTML-—Ñ–∞–π–ª—É –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    try:
        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        CATEGORIES = {
            "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ": ["–§–ò–û", "–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø", "–†–ï–ì–ò–û–ù", "–ê–î–†–ï–°", "–ö–û–î –ò–ó–ë–ò–†–ê–¢–ï–õ–Ø", "–ö–ê–¢–ï–ì–û–†–ò–Ø –õ–ò–¶–ê"],
            "–ö–æ–Ω—Ç–∞–∫—Ç—ã": ["–¢–ï–õ–ï–§–û–ù", "–¢–ï–õ–ï–§–û–ù –î–û–ú–ê–®–ù–ò–ô", "–°–í–Ø–ó–¨", "–ü–û–ß–¢–ê"],
            "–î–æ–∫—É–º–µ–Ω—Ç—ã": ["–ü–ê–°–ü–û–†–¢", "–ò–ù–ù", "–°–ù–ò–õ–°", "–î–û–ö–£–ú–ï–ù–¢", "–ü–û–õ–ò–°", "–î–ê–¢–ê –í–´–î–ê–ß–ò", "–î–ê–¢–ê –í–´–î–ê–ß–ò –ü–û–õ–ò–°",
                          "–ö–ï–ú –í–´–î–ê–ù", "–í–û–î–ò–¢–ï–õ–¨–°–ö–û–ï –£–î–û–°–¢–û–í–ï–†–ï–ù–ò–ï"],
            "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è": ["–î–û–õ–ñ–ù–û–°–¢–¨", "–ú–ï–°–¢–û –†–ê–ë–û–¢–´", "–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò"],
            "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è": ["–î–û–õ–ì", "–î–ê–¢–ê –ò–ü", "–ù–û–ú–ï–† –ò–ü", "–û–°–ü"],
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ": ["–ì–û–° –ù–û–ú–ï–†", "–ú–û–î–ï–õ–¨ –ê–í–¢–û", "–ì–û–î –í–´–ü–£–°–ö–ê", "VIN", "–¶–í–ï–¢ –ê–í–¢–û"]
        }

        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å –¥–ª—è –≤—Å–µ—Ö HTML-–æ—Ç—á–µ—Ç–æ–≤
        base_dir = "static"  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–¥–∏–Ω—É—é –±–∞–∑–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        user_dir = os.path.join(base_dir, "responses", str(user_id))

        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        try:
            os.makedirs(user_dir, exist_ok=True)
        except PermissionError:
            logging.error(f"‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {user_dir}")
            return None
        except Exception as e:
            logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ {user_dir}: {e}")
            return None

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        if not os.access(os.path.dirname(user_dir), os.W_OK):
            logging.error(f"‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: {os.path.dirname(user_dir)}")
            return None

        safe_query = query.replace("/", "_").replace("\\", "_")
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        file_name = f"{safe_query}_{timestamp}.html"
        file_path = os.path.join(user_dir, file_name)

        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        summary_data = {}
        for category, fields in CATEGORIES.items():
            summary_data[category] = {}

        # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∑–∞–ø–∏—Å—è–º –¥–ª—è —Å–±–æ—Ä–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        for record in api_response:
            if not isinstance(record, dict):
                continue

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ –∫–æ—Ä—Ç–µ–∂–µ–π
            if "fields" in record and isinstance(record["fields"], list):
                for key, value in record["fields"]:
                    key = key.upper()  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É

                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—è
                    for category, fields in CATEGORIES.items():
                        if key in fields:
                            if key not in summary_data[category]:
                                summary_data[category][key] = []
                            if value not in summary_data[category][key]:
                                summary_data[category][key].append(value)
            else:
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞–ø—Ä—è–º—É—é –∫–∞–∫ –∫–ª—é—á–∏ —Å–ª–æ–≤–∞—Ä—è
                for key, value in record.items():
                    if key == "database":
                        continue

                    key = key.upper()  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É

                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—è
                    found_category = False
                    for category, fields in CATEGORIES.items():
                        if key in fields:
                            if key not in summary_data[category]:
                                summary_data[category][key] = []

                            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–æ–≤ –∏ —Å—Ç—Ä–æ–∫
                            if isinstance(value, list):
                                for v in value:
                                    if v not in summary_data[category][key]:
                                        summary_data[category][key].append(v)
                            else:
                                if value not in summary_data[category][key]:
                                    summary_data[category][key].append(value)
                            found_category = True
                            break

                    # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –≤ "–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ"
                    if not found_category:
                        if "–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ" not in summary_data:
                            summary_data["–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ"] = {}
                        if key not in summary_data["–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ"]:
                            summary_data["–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ"][key] = []

                        if isinstance(value, list):
                            for v in value:
                                if v not in summary_data["–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ"][key]:
                                    summary_data["–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ"][key].append(v)
                        else:
                            if value not in summary_data["–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ"][key]:
                                summary_data["–î—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ"][key].append(value)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—É—é –Ω–µ–ø—É—Å—Ç—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
        active_category = None
        for category, data in summary_data.items():
            if data:
                active_category = category
                break

        if not active_category:
            active_category = list(CATEGORIES.keys())[0]

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML-–∫–æ–¥
        with open(file_path, "w", encoding="utf-8") as f:
            f.write(f"""<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>{html_escape.escape(query)}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1a1d24">
</head>
<body>

<style>
  :root {{
    /* –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ (—Ç–µ–º–Ω–∞—è) */
    --color-primary: #3498db;
    --color-primary-light: #214559;
    --color-secondary: #6c7a89;
    --color-accent: #e74c3c;
    --color-success: #2ecc71;
    --color-warning: #f39c12;
    --color-danger: #e74c3c;
    --color-info: #3498db;

    /* –¢–µ–∫—Å—Ç */
    --color-text: #ecf0f1;
    --color-text-secondary: #bdc3c7;
    --color-text-light: #7f8c8d;

    /* –§–æ–Ω—ã */
    --color-bg: #101214;
    --color-bg-paper: #1a1d24;
    --color-bg-card: #23272e;
    --color-bg-section: #1e222a;

    /* –ì—Ä–∞–Ω–∏—Ü—ã */
    --color-border: #2c3e50;
    --color-border-light: #34495e;

    /* –†–∞–∑–º–µ—Ä—ã */
    --spacing-unit: 8px;
    --border-radius: 4px;
    --tab-height: 40px;

    /* –¢–µ–Ω–∏ */
    --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.2);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.2);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4), 0 4px 6px -2px rgba(0,0,0,0.3);
  }}

  /* –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π */
  *, *::before, *::after {{
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }}

  html {{
    font-size: 16px;
    scroll-behavior: smooth;
  }}

  body {{
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background-color: var(--color-bg);
    color: var(--color-text);
    line-height: 1.5;
    padding-bottom: 2rem;
  }}

  a {{
    color: var(--color-primary);
    text-decoration: none;
  }}

  a:hover {{
    text-decoration: underline;
  }}

  /* –£—Ç–∏–ª–∏—Ç—ã */
  .container {{
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-unit);
  }}

  .flex {{
    display: flex;
  }}

  .flex-col {{
    flex-direction: column;
  }}

  .items-center {{
    align-items: center;
  }}

  .justify-between {{
    justify-content: space-between;
  }}

  .gap-2 {{
    gap: calc(var(--spacing-unit) * 2);
  }}

  .py-2 {{
    padding-top: calc(var(--spacing-unit) * 2);
    padding-bottom: calc(var(--spacing-unit) * 2);
  }}

  .mb-2 {{
    margin-bottom: calc(var(--spacing-unit) * 2);
  }}

  .mb-4 {{
    margin-bottom: calc(var(--spacing-unit) * 4);
  }}

  /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
  .page-header {{
    background-color: var(--color-bg-paper);
    border-bottom: 1px solid var(--color-border);
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: var(--shadow-sm);
  }}

  .header-content {{
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: calc(var(--spacing-unit) * 2) 0;
  }}

  .page-title {{
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text);
  }}

  .page-subtitle {{
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-top: 4px;
  }}

  .badge {{
    background-color: var(--color-primary-light);
    color: var(--color-primary);
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    margin-left: 0.5rem;
  }}

  .header-actions {{
    display: flex;
    gap: calc(var(--spacing-unit));
  }}

  .btn {{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.15s ease;
    border: 1px solid transparent;
  }}

  .btn-outline {{
    background-color: transparent;
    border-color: var(--color-border);
    color: var(--color-text-secondary);
  }}

  .btn-outline:hover {{
    background-color: var(--color-bg-section);
    border-color: var(--color-text-secondary);
  }}

  .btn-primary {{
    background-color: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }}

  .btn-primary:hover {{
    background-color: #2980b9;
    border-color: #2980b9;
  }}

  /* –û—Å–Ω–æ–≤–Ω–æ–π layout */
  .main-layout {{
    display: flex;
    margin-top: calc(var(--spacing-unit) * 3);
  }}

  .main-content {{
    flex: 1;
    margin-right: calc(var(--spacing-unit) * 3);
  }}

  .sidebar {{
    width: 280px;
    position: sticky;
    top: calc(var(--spacing-unit) * 8);
    height: calc(100vh - var(--spacing-unit) * 12);
    overflow-y: auto;
  }}

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
  .card {{
    background-color: var(--color-bg-card);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--color-border);
    margin-bottom: calc(var(--spacing-unit) * 3);
    overflow: hidden;
  }}

  .card-header {{
    padding: calc(var(--spacing-unit) * 2);
    background-color: var(--color-bg-section);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }}

  .card-title {{
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
  }}

  .card-body {{
    padding: calc(var(--spacing-unit) * 2);
  }}

  /* –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
  .summary-card .card-body {{
    padding: 0;
  }}

  .summary-tabs {{
    display: flex;
    border-bottom: 1px solid var(--color-border);
    overflow-x: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--color-border) var(--color-bg-section);
  }}

  .summary-tabs::-webkit-scrollbar {{
    height: 6px;
  }}

  .summary-tabs::-webkit-scrollbar-thumb {{
    background-color: var(--color-border);
    border-radius: 3px;
  }}

  .summary-tabs::-webkit-scrollbar-track {{
    background-color: var(--color-bg-section);
  }}

  .tab {{
    padding: 0 calc(var(--spacing-unit) * 2);
    height: var(--tab-height);
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }}

  .tab.active {{
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }}

  .tab:hover:not(.active) {{
    color: var(--color-text);
    background-color: var(--color-bg-section);
  }}

  .tab-content {{
    display: none;
    padding: calc(var(--spacing-unit) * 2);
  }}

  .tab-content.active {{
    display: block;
  }}

  .personal-info {{
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: calc(var(--spacing-unit) * 2);
  }}

  .info-group {{
    margin-bottom: calc(var(--spacing-unit) * 2);
  }}

  .info-label {{
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-text-light);
    margin-bottom: calc(var(--spacing-unit) / 2);
  }}

  .info-value {{
    font-size: 0.875rem;
    word-break: break-word;
  }}

  /* –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö */
  .source-card {{
    transition: all 0.2s;
  }}

  .source-card:hover {{
    box-shadow: var(--shadow-md);
  }}

  .source-header {{
    cursor: pointer;
    user-select: none;
  }}

  .source-title {{
    display: flex;
    align-items: center;
    gap: calc(var(--spacing-unit));
  }}

  .source-icon {{
    font-size: 1.125rem;
    background-color: var(--color-primary-light);
    color: var(--color-primary);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }}

  .source-name {{
    font-size: 0.875rem;
    font-weight: 600;
  }}

  .source-date {{
    font-size: 0.75rem;
    color: var(--color-text-light);
  }}

  .source-body {{
    max-height: none; /* –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ */
    overflow: visible;
  }}

  .data-table {{
    width: 100%;
    border-collapse: collapse;
  }}

  .data-table tr {{
    border-bottom: 1px solid var(--color-border-light);
  }}

  .data-table tr:last-child {{
    border-bottom: none;
  }}

  .data-table td {{
    padding: calc(var(--spacing-unit)) 0;
    font-size: 0.875rem;
    vertical-align: top;
  }}

  .data-table td:first-child {{
    width: 30%;
    color: var(--color-text-secondary);
    padding-right: calc(var(--spacing-unit) * 2);
    font-weight: 500;
  }}

  .highlight {{
    color: var(--color-primary);
    font-weight: 600;
  }}

  /* –°–∞–π–¥–±–∞—Ä */
  .sidebar-card {{
    background-color: var(--color-bg-card);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--color-border);
    overflow: hidden;
  }}

  .sidebar-title {{
    padding: calc(var(--spacing-unit) * 1.5);
    font-size: 0.875rem;
    font-weight: 600;
    border-bottom: 1px solid var(--color-border);
  }}

  .sidebar-body {{
    padding: calc(var(--spacing-unit));
  }}

  .nav-list {{
    list-style: none;
  }}

  .nav-item {{
    margin-bottom: 1px;
  }}

  .nav-link {{
    display: block;
    padding: calc(var(--spacing-unit));
    font-size: 0.75rem;
    color: var(--color-text);
    border-radius: var(--border-radius);
    transition: all 0.15s;
  }}

  .nav-link:hover {{
    background-color: var(--color-bg-section);
    text-decoration: none;
  }}

  .nav-link.active {{
    background-color: var(--color-primary-light);
    color: var(--color-primary);
    font-weight: 500;
  }}

  .source-tag {{
    display: inline-block;
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 1rem;
    background-color: var(--color-primary-light);
    color: var(--color-primary);
    margin-left: 0.25rem;
  }}

  /* Responsive */
  @media (max-width: 768px) {{
    .main-layout {{
      flex-direction: column;
    }}

    .main-content {{
      margin-right: 0;
    }}

    .sidebar {{
      width: 100%;
      position: static;
      height: auto;
      margin-top: calc(var(--spacing-unit) * 2);
    }}

    .header-content {{
      flex-direction: column;
      align-items: flex-start;
    }}

    .header-actions {{
      margin-top: calc(var(--spacing-unit) * 2);
      width: 100%;
      justify-content: flex-end;
    }}

    .data-table td {{
      display: block;
      width: 100% !important;
    }}

    .data-table td:first-child {{
      padding-bottom: 0;
    }}
  }}

  /* –ü–µ—á–∞—Ç—å */
  @media print {{
    body {{
      background: white;
      color: black;
    }}

    .page-header {{
      position: static;
      box-shadow: none;
      background-color: white;
      color: black;
      border-bottom: 1px solid #ddd;
    }}

    .header-actions, .sidebar {{
      display: none !important;
    }}

    .card, .source-card {{
      break-inside: avoid;
      box-shadow: none;
      background-color: white;
      border: 1px solid #ddd;
    }}

    .card-header {{
      background-color: #f5f5f5;
      color: black;
    }}

    .data-table td {{
      color: black !important;
    }}

    .data-table td:first-child {{
      color: #555 !important;
    }}

    .highlight {{
      color: #2980b9 !important;
    }}

    /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –≤–∏–¥–Ω—ã */
    .tab-content {{
      display: block !important;
      page-break-inside: avoid;
      border-top: 1px dashed #ddd;
      padding-top: 1rem;
      margin-top: 0.5rem;
    }}

    .tab {{
      display: none;
    }}

    .tab.active {{
      display: block;
      border: none;
      padding: 0;
      margin: 1rem 0 0.5rem;
      font-weight: bold;
      font-size: 1.1rem;
    }}
  }}
</style>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<header class="page-header">
  <div class="container">
    <div class="header-content">
      <div>
        <h1 class="page-title">{html_escape.escape(query)}</h1>
        <p class="page-subtitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ <span class="badge">{len(api_response)} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</span></p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="window.print()">
          <span>–ü–µ—á–∞—Ç—å</span>
        </button>
        <button class="btn btn-primary" onclick="savePDF()">
          <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PDF</span>
        </button>
      </div>
    </div>
  </div>
</header>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<main class="container">
  <div class="main-layout">
    <div class="main-content">
      <!-- –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="card summary-card mb-4">
        <div class="card-header">
          <h2 class="card-title">–°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        </div>

        <div class="summary-tabs">
""")

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            for i, category in enumerate(summary_data.keys()):
                if summary_data[category]:  # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                    is_active = category == active_category
                    active_class = "active" if is_active else ""
                    f.write(
                        f"""          <div class="tab {active_class}" data-tab="{category.lower().replace(' ', '_')}">{category}</div>\n""")

            f.write("""        </div>

""")

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫
            for category, data in summary_data.items():
                if not data:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    continue

                is_active = category == active_category
                active_class = "active" if is_active else ""
                category_id = category.lower().replace(' ', '_')

                f.write(f"""        <div id="{category_id}" class="tab-content {active_class}">
          <div class="personal-info">
""")

                # –í—ã–≤–æ–¥–∏–º –ø–æ–ª—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                for field, values in data.items():
                    if not values:
                        continue

                    f.write(f"""            <div class="info-group">
              <div class="info-label">{html_escape.escape(field)}</div>
              <div class="info-value">
""")

                    # –í—ã–≤–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è
                    for value in values:
                        if value:
                            safe_value = html_escape.escape(str(value))
                            f.write(f"""                {safe_value}<br>
""")

                    f.write("""              </div>
            </div>
""")

                f.write("""          </div>
        </div>
""")

            f.write("""      </div>

      <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö -->
      <h2 class="card-title mb-2">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h2>
""")

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            for i, record in enumerate(api_response):
                if not isinstance(record, dict):
                    continue

                db_name = record.get("database", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –±–∞–∑–∞")
                source_id = f"source{i}"

                f.write(f"""      
      <!-- –ò—Å—Ç–æ—á–Ω–∏–∫ {i + 1} -->
      <div class="card source-card" id="{source_id}">
        <div class="card-header source-header">
          <div class="source-title">
            <div class="source-icon">üìä</div>
            <div>
              <div class="source-name">{html_escape.escape(db_name)}</div>
            </div>
          </div>
        </div>
        <div class="source-body">
          <div class="card-body">
            <table class="data-table">
              <tbody>
""")

                # –í—ã–≤–æ–¥–∏–º –ø–æ–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                if "fields" in record and isinstance(record["fields"], list):
                    for key, value in record["fields"]:
                        if key and value:
                            key_safe = html_escape.escape(str(key).upper())
                            val_safe = html_escape.escape(str(value))

                            # –í—ã–¥–µ–ª—è–µ–º –§–ò–û –∂–∏—Ä–Ω—ã–º
                            highlight_class = "highlight" if key.upper() == "–§–ò–û" else ""

                            f.write(f"""                <tr>
                  <td>{key_safe}</td>
                  <td class="{highlight_class}">{val_safe}</td>
                </tr>
""")
                else:
                    for key, value in record.items():
                        if key == "database":
                            continue

                        if key and value:
                            key_safe = html_escape.escape(str(key).upper())

                            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–æ–≤
                            if isinstance(value, list):
                                val_safe = "<br>".join([html_escape.escape(str(v)) for v in value if v])
                            else:
                                val_safe = html_escape.escape(str(value))

                            # –í—ã–¥–µ–ª—è–µ–º –§–ò–û –∂–∏—Ä–Ω—ã–º
                            highlight_class = "highlight" if key.upper() == "–§–ò–û" else ""

                            f.write(f"""                <tr>
                  <td>{key_safe}</td>
                  <td class="{highlight_class}">{val_safe}</td>
                </tr>
""")

                f.write("""              </tbody>
            </table>
          </div>
        </div>
      </div>
""")

            # –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
            f.write("""    </div>

    <div class="sidebar">
      <div class="sidebar-card">
        <div class="sidebar-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</div>
        <div class="sidebar-body">
          <ul class="nav-list">
""")

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
            for i, record in enumerate(api_response):
                if not isinstance(record, dict):
                    continue

                db_name = record.get("database", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –±–∞–∑–∞")
                source_id = f"source{i}"

                # –ü–µ—Ä–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–∫—Ç–∏–≤–Ω—ã–π
                active_class = "active" if i == 0 else ""

                f.write(f"""            <li class="nav-item">
              <a href="#{source_id}" class="nav-link {active_class}" onclick="scrollToSource('{source_id}', event)">
                {html_escape.escape(db_name)}
              </a>
            </li>
""")

            f.write("""          </ul>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –≤ —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç—ã
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏ –∫–æ–Ω—Ç–µ–Ω—Ç
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    });
  });

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É
  function scrollToSource(id, event) {
    if (event) {
      event.preventDefault();
    }

    const sourceCard = document.getElementById(id);

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Å—ã–ª–∫—É
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });
    document.querySelector(`a[href="#${id}"]`).classList.add('active');

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
    sourceCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

    return false;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ PDF (–ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞)
  function savePDF() {
    // –í –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–µ—á–∞—Ç–∏
    window.print();

    // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å window.jspdf, –µ—Å–ª–∏ –æ–Ω–∞ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
  }

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('load', function() {
    // –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å —è–∫–æ—Ä—å, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–µ–º—É
    if (window.location.hash) {
      const id = window.location.hash.substring(1);
      if (document.getElementById(id)) {
        scrollToSource(id);
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —è–∫–æ—Ä–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      const id = this.getAttribute('href').substring(1);
      if (document.getElementById(id)) {
        e.preventDefault();
        scrollToSource(id);
      }
    });
  });
</script>

</body>
</html>
""")

        logging.info(f"‚úÖ HTML-–æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {file_path}")
        return file_path

    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ HTML-—Ñ–∞–π–ª–∞: {e}")
        return None


def get_api_balance():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (success: bool, response: str).
    –ü—Ä–∏–º–µ—Ä: (True, "–ë–∞–ª–∞–Ω—Å API: $100.25")
    –ò–ª–∏ (False, "–û—à–∏–±–∫–∞ 401: –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω")
    """
    if not API_TOKEN:
        return False, "–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç API_TOKEN –≤ .env."

    url = f"{API_BASE_URL}/api/{API_TOKEN}/profile"
    try:
        resp = requests.get(url, timeout=10)
        if resp.status_code == 401:
            return False, "–û—à–∏–±–∫–∞ 401: –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π API-—Ç–æ–∫–µ–Ω."
        if resp.status_code == 500:
            return False, "–û—à–∏–±–∫–∞ 500: –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ API."

        data = resp.json()
        if "profile" in data:
            bal = data["profile"].get("balance", 0.0)
            return True, f"–ë–∞–ª–∞–Ω—Å API: ${bal:.2f}"
        elif "error" in data:
            return False, f"–û—à–∏–±–∫–∞ API: {data['error']}"
        else:
            return False, "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç API."
    except requests.exceptions.RequestException as e:
        return False, f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API: {e}"


def filter_unique_data(api_response):
    """
    –£–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π: –§–ò–û, –î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø, –¢–ï–õ–ï–§–û–ù, –ü–ê–°–ü–û–†–¢, –ò–ù–ù.
    –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è + database –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç "–æ—á–∏—â–µ–Ω–Ω—ã–π" —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π.
    """
    unique_values = {
        "–§–ò–û": set(),
        "–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø": set(),
        "–¢–ï–õ–ï–§–û–ù": set(),
        "–ü–ê–°–ü–û–†–¢": set(),
        "–ò–ù–ù": set()
    }

    filtered_data = []

    for record in api_response:
        if not isinstance(record, dict):
            continue

        filtered_record = {}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π
        for key in unique_values:
            value = record.get(key)
            if value and value not in unique_values[key]:
                unique_values[key].add(value)
                filtered_record[key] = value

        # –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º database, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if "database" in record:
            filtered_record["database"] = record["database"]

        # –ï—Å–ª–∏ filtered_record –Ω–µ –ø—É—Å—Ç, –¥–æ–±–∞–≤–ª—è–µ–º
        if filtered_record:
            filtered_data.append(filtered_record)

    return filtered_data


async def get_or_translate_database_name(original_name):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞.
    –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º.
    """
    return original_name

def setup_translation_db():
    """
    –§—É–Ω–∫—Ü–∏—è-–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
    –ë–æ–ª—å—à–µ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
    """
    pass


def format_fio_and_date(query: str) -> str:
    """
    –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –§–ò–û –∏ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è:
    - –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –¥–∞—Ç—É –≤ –ª—é–±–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏
    - –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–∞—Ç—ã
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–≤—É–∑–Ω–∞—á–Ω—ã–µ –≥–æ–¥—ã
    """
    parts = query.strip().split()
    if len(parts) < 2:
        return query  # —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Ç—Ä–æ–∫–∞

    # –ò—â–µ–º —á–∞—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—Ö–æ–∂–∞ –Ω–∞ –¥–∞—Ç—É
    date_index = None
    date_part = None
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –≤ –¥–∞—Ç–µ (., -, /)
    date_pattern = r"^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$"

    for i, part in enumerate(parts):
        match = re.match(date_pattern, part)
        if match:
            date_index = i
            day, month, year = match.groups()

            # –î–æ–±–∞–≤–ª—è–µ–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ –¥–ª—è –¥–Ω—è –∏ –º–µ—Å—è—Ü–∞
            day = day.zfill(2)
            month = month.zfill(2)

            # –ü—Ä–∏–≤–æ–¥–∏–º –≥–æ–¥ –∫ 4-–∑–Ω–∞—á–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É, –µ—Å–ª–∏ –æ–Ω 2-–∑–Ω–∞—á–Ω—ã–π
            if len(year) == 2:
                # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≥–æ–¥ 20XX –µ—Å–ª–∏ < 30, –∏–Ω–∞—á–µ 19XX
                year_prefix = "20" if int(year) < 30 else "19"
                year = year_prefix + year

            date_part = f"{day}.{month}.{year}"
            break

    # –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É
    if date_index is not None:
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∞—Å—Ç–∏ –§–ò–û (–≤—Å–µ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã)
        fio_parts = [p.capitalize() for i, p in enumerate(parts) if i != date_index]

        # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π
        result = " ".join(fio_parts) + " " + date_part
        return result

    # –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∫ –§–ò–û
    return " ".join(p.capitalize() for p in parts)


def normalize_query(query: str) -> str:
    """
    –ü—Ä–∏–≤–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫—É –∫ —Ñ–æ—Ä–º–∞—Ç—É:
    - –§–ò–û (–∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã)
    - –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (DD.MM.YYYY), –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç–∞ –≤ –ª—é–±–æ–π –ø–æ–∑–∏—Ü–∏–∏
    """
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    formatted_query = format_fio_and_date(query)

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
    date_pattern = r'(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})'
    if re.search(date_pattern, formatted_query):
        # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç–∞ –≤ —Å—Ç—Ä–æ–∫–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        date_match = re.search(date_pattern, formatted_query)
        if date_match:
            day, month, year = date_match.groups()

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
            day = day.zfill(2)
            month = month.zfill(2)
            if len(year) == 2:
                year_prefix = "20" if int(year) < 30 else "19"
                year = year_prefix + year

            formatted_date = f"{day}.{month}.{year}"

            # –ó–∞–º–µ–Ω—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—É—é –¥–∞—Ç—É –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é
            formatted_query = formatted_query.replace(date_match.group(0), formatted_date)

    return formatted_query


async def test_message_sending(bot, user_id):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

    :param bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
    :param user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    :return: (success, error_message)
    """
    try:
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —á–∞—Ç–∞
        try:
            chat = await bot.get_chat(user_id)
        except Exception as e:
            return False, f"–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: {str(e)}"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ
        if chat.type != 'private':
            try:
                bot_member = await bot.get_chat_member(chat.id, (await bot.get_me()).id)
                if not bot_member.can_send_messages:
                    return False, "–ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ"
            except Exception as e:
                return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∞–≤ –±–æ—Ç–∞: {str(e)}"

        return True, None
    except Exception as e:
        return False, str(e)


def format_phone_number(phone_str):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –≤–∏–¥—É –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤

    :param phone_str: –°—Ç—Ä–æ–∫–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º
    :return: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ None
    """
    if not phone_str:
        return None

    # –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    digits_only = ''.join(c for c in str(phone_str) if c.isdigit())

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É (–æ—Ç—Å–µ–∏–≤–∞–µ–º —è–≤–Ω–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ)
    if len(digits_only) < 10:
        return None

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –º–æ–±–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
    if len(digits_only) == 10 and digits_only[0] in ['9', '8', '7', '6', '5', '4', '3']:
        return f"+7{digits_only}"
    elif len(digits_only) == 11 and digits_only[0] in ['7', '8']:
        return f"+7{digits_only[1:]}"
    elif len(digits_only) > 11:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (–ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º +)
        return f"+{digits_only}"
    else:
        # –ï—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –¥–ª–∏–Ω–∞ –æ—Ç 10 –¥–æ 11 —Ü–∏—Ñ—Ä, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ —ç—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω
        if 10 <= len(digits_only) <= 11:
            if digits_only[0] == '8':
                return f"+7{digits_only[1:]}"
            elif digits_only[0] == '7':
                return f"+7{digits_only[1:]}"
            else:
                return f"+{digits_only}"

    # –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–æ—à–ª–æ –Ω–∏ –ø–æ–¥ –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
    return None


async def test_mass_search_process(bot, admin_id, test_file_path):
    """
    –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø—Ä–æ–±–∏–≤–∞

    :param bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
    :param admin_id: ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞
    :param test_file_path: –ü—É—Ç—å –∫ —Ç–µ—Å—Ç–æ–≤–æ–º—É —Ñ–∞–π–ª—É
    :return: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ (—É—Å–ø–µ—Ö/–Ω–µ—É–¥–∞—á–∞)
    """
    try:
        from bot.mass_search import MassSearchProcessor

        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
        processor = MassSearchProcessor()
        result_file_path, stats, results_dict = await processor.process_file(test_file_path, admin_id)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ç–µ—Å—Ç–∞
        report = f"–¢–µ—Å—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ –ø—Ä–æ–±–∏–≤–∞ –∑–∞–≤–µ—Ä—à–µ–Ω:\n"
        report += f"- –ù–∞–π–¥–µ–Ω–æ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤: {stats.get('phones_found', 0)}\n"
        report += f"- –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {stats.get('valid_lines', 0)}\n"
        report += f"- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {stats.get('processing_time', 0)} —Å–µ–∫\n"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        await bot.send_message(admin_id, report)

        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ —Ç–æ–∂–µ
        if result_file_path and os.path.exists(result_file_path):
            await bot.send_document(admin_id, FSInputFile(result_file_path))

        return True
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø—Ä–æ–±–∏–≤–∞: {e}", exc_info=True)
        await bot.send_message(admin_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø—Ä–æ–±–∏–≤–∞: {e}")
        return False


def sorted_items_by_category(category, items):
    """
    –°–æ—Ä—Ç–∏—Ä—É–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

    :param category: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    :param items: –°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    :return: –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    """
    if category == "–ó–ê–ü–ò–°–ê–ù –í –ë–ê–ó–ê–•":
        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –§–ò–û –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        return sorted(items)
    elif category == "–î–ê–¢–ê –†–û–ñ–î–ï–ù–ò–Ø":
        # –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–∞—Ç (–µ—Å–ª–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì)
        try:
            # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –¥–∞—Ç—ã
            from datetime import datetime

            def parse_date(date_str):
                try:
                    if isinstance(date_str, str) and '.' in date_str:
                        parts = date_str.split('.')
                        if len(parts) == 3:
                            return datetime(int(parts[2]), int(parts[1]), int(parts[0]))
                    return datetime(1900, 1, 1)  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                except:
                    return datetime(1900, 1, 1)  # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞

            return sorted(items, key=parse_date)
        except:
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ—Å—Ç–æ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            return sorted(items)
    elif category == "–¢–ï–õ–ï–§–û–ù":
        # –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ - —Å–Ω–∞—á–∞–ª–∞ –º–æ–±–∏–ª—å–Ω—ã–µ (+7), –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
        mobile = []
        other = []

        for phone in items:
            if phone and isinstance(phone, str) and phone.startswith('+7'):
                mobile.append(phone)
            else:
                other.append(phone)

        return sorted(mobile) + sorted(other)
    else:
        # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π - –ø—Ä–æ—Å—Ç–æ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        return sorted(items)